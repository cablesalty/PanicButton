<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="index.css">
    <title>Panic Button</title>
</head>

<body>
    <h1>Panic Button</h1>
    <hr>
    <h3>Panic Key</h3>
    <p id="currentlyBoundKeyDisplay">Loading currently bound key...</p>
    <button onclick="startKeyIdentification()" id="changeBindingBtn">Change key binding...</button><br>
    <br>
    <hr>
    <h3>Panic REACTION</h3>
    <label for="pr">Choose a reaction:</label>
    <select name="pr" id="pr">
        <option value="fakedesktop">Show a fake desktop (full screen)</option>
        <option value="minimizeall">Minimize all windows</option>
        <option value="poweroff">Shut down the computer</option>
    </select>
    <p><i>(Audio will be muted no matter what you choose here.)</i></p>
    <br>
    <hr>
    <br>
    <button onclick="saveConfig()" id="saveConfigBtn">Save config</button><br>
    <p style="color: red;">
        <i>Warning! Close the configuration window after you are done!
            Panic REACTION might NOT work if config window is open!
            PanicButton will remain running in the background until you quit
        </i>
    </p>

    <script>
        // Modules
        const fs = require('fs');

        // Read config.json synchronously
        const configPath = __dirname + '/config.json'; // Path to config
        const configData = fs.readFileSync(configPath, 'utf8'); // Read file
        const config = JSON.parse(configData); // Parse json
        const modifiedConfig = JSON.parse(JSON.stringify(config)); // Create duplicate (for modification)


        // Update values based on config
        document.getElementById("currentlyBoundKeyDisplay").innerHTML = "Currently bound key: " + config.panickey;



        // Key Identification
        let isIdentifying = false;

        function startKeyIdentification() {
            if (!isIdentifying) {
                document.getElementById("changeBindingBtn").innerHTML = "Press a button! (Click to cancel)";
                isIdentifying = true;
                document.addEventListener("keydown", keyDownHandler);
            } else {
                isIdentifying = false;
                document.removeEventListener("keydown", keyDownHandler);
                document.getElementById("changeBindingBtn").innerHTML = "Change key binding...";
            }
        }

        function keyDownHandler(event) {
            const keyPressedElement = document.getElementById("currentlyBoundKeyDisplay"); // Move this line here
            const pressedKey = event.key.toUpperCase();
            keyPressedElement.textContent = `Currently bound key: ${pressedKey}`;
            modifiedConfig.panickey = pressedKey;
            document.removeEventListener("keydown", keyDownHandler);
            isIdentifying = false;
            document.getElementById("changeBindingBtn").innerHTML = "Change key binding...";
        }


        // Function saving
        async function saveConfig() {
            modifiedConfig.panicreaction = document.getElementById("pr").value;
            fs.writeFileSync(configPath, JSON.stringify(modifiedConfig, null, 2));
            document.getElementById("saveConfigBtn").innerHTML = "Saved!";
            setTimeout(() => {
                document.getElementById("saveConfigBtn").innerHTML = "Save config";
            }, 2000);
        }
    </script>
</body>

</html>